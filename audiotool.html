<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LRC Editor with File Upload, History & More</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }

        body {
            background: #f6f8fb;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 25px;
            overflow-x: hidden;
        }

        .container {
            width: 100%;
            max-width: 700px;
            background: #fff;
            border-radius: 25px;
            box-shadow: 0 12px 35px rgba(0,0,0,0.1);
            padding: 35px;
            position: relative;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 32px;
            color: #333;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .file-upload {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            margin-bottom: 25px;
        }

        .file-input {
            display: none;
        }

        .upload-btn {
            padding: 12px 25px;
            font-size: 16px;
            background: #87CEFA;
            color: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s, transform 0.2s;
            position: relative;
            z-index: 10;
        }

        .upload-btn:hover {
            background: #1db954;
            transform: scale(1.05);
        }

        .file-name {
            font-size: 16px;
            color: #666;
            word-break: break-all;
            text-align: center;
            max-width: 100%;
        }

        .player {
            background: linear-gradient(135deg, #87CEFA, #ffffff);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .song-info {
            text-align: center;
            margin-bottom: 25px;
        }

        .song-name {
            font-size: 24px;
            font-weight: 600;
            color: #222;
        }

        .artist {
            font-size: 17px;
            color: #666;
        }

        .progress-container {
            display: flex;
            align-items: center;
            margin: 25px 0;
        }

        .time {
            font-size: 15px;
            min-width: 55px;
            color: #444;
        }

        .progress-bar {
            flex: 1;
            height: 8px;
            background: #d9e1e9;
            border-radius: 4px;
            margin: 0 20px;
            position: relative;
            cursor: pointer;
        }

        .progress {
            height: 100%;
            border-radius: 4px;
            background: #1db954;
            transition: width 0.1s linear;
        }

        .controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 25px;
        }

        .control-btn {
            background: none;
            border: none;
            font-size: 26px;
            cursor: pointer;
            color: #333;
            padding: 10px;
            transition: transform 0.2s, color 0.2s;
        }

        .control-btn:hover {
            transform: scale(1.15);
            color: #1db954;
        }

        .lyrics-container {
            max-height: 320px;
            overflow-y: auto;
            padding: 25px;
            background: #fafcff;
            border-radius: 12px;
            margin-bottom: 30px;
        }

        .lyrics-container::-webkit-scrollbar {
            width: 8px;
        }

        .lyrics-container::-webkit-scrollbar-thumb {
            background: #87CEFA;
            border-radius: 4px;
        }

        .lyric-line {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 16px;
            color: #333;
            margin: 12px 0;
            padding: 5px 10px;
            transition: all 0.3s ease;
        }

        .lyric-line.active {
            color: #87CEFA;
            font-size: 19px;
            font-weight: bold;
        }

        .delete-btn {
            background: none;
            border: none;
            font-size: 16px;
            color: #ff4444;
            cursor: pointer;
            padding: 5px;
            transition: transform 0.2s;
        }

        .delete-btn:hover {
            transform: scale(1.2);
            color: #ff6666;
        }

        .add-lyric {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
        }

        .add-btn {
            padding: 12px 25px;
            font-size: 16px;
            background: #87CEFA;
            color: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s, transform 0.2s;
        }

        .add-btn:hover {
            background: #1db954;
            transform: scale(1.05);
        }

        .lyric-input-container {
            display: none;
            flex: 1;
            gap: 10px;
        }

        .lyric-input {
            padding: 12px;
            font-size: 16px;
            border: 2px solid #87CEFA;
            border-radius: 8px;
            flex: 1;
            max-width: 350px;
        }

        .lyric-input:focus {
            outline: none;
            border-color: #1db954;
        }

        .confirm-btn {
            padding: 12px 20px;
            font-size: 16px;
            background: #1db954;
            color: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s, transform 0.2s;
        }

        .confirm-btn:hover {
            background: #87CEFA;
            transform: scale(1.05);
        }

        .output-section {
            text-align: center;
            margin-bottom: 30px;
        }

        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .output-btn, .new-lrc-btn, .download-btn {
            padding: 12px 25px;
            font-size: 16px;
            background: #1db954;
            color: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s, transform 0.2s;
        }

        .new-lrc-btn {
            background: #ffa500;
        }

        .download-btn {
            background: #ff4444;
        }

        .output-btn:hover, .new-lrc-btn:hover, .download-btn:hover {
            background: #87CEFA;
            transform: scale(1.05);
        }

        .lrc-output {
            margin-top: 25px;
            padding: 20px;
            background: #fafcff;
            border-radius: 12px;
            font-size: 14px;
            color: #333;
            white-space: pre-wrap;
            border: 1px solid #e0e7ff;
            min-height: 100px;
            text-align: left;
        }

        .history-section {
            margin-top: 30px;
            padding: 25px;
            background: #f9fbfd;
            border-radius: 12px;
            max-height: 300px;
            overflow-y: auto;
        }

        .history-section h2 {
            font-size: 20px;
            color: #333;
            margin-bottom: 15px;
            text-align: center;
        }

        .history-section::-webkit-scrollbar {
            width: 8px;
        }

        .history-section::-webkit-scrollbar-thumb {
            background: #87CEFA;
            border-radius: 4px;
        }

        .history-entry {
            font-size: 14px;
            color: #555;
            margin: 10px 0;
            padding: 10px;
            background: #fff;
            border-radius: 8px;
            border: 1px solid #e0e7ff;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>LRC 编辑器</h1>
            <div class="file-upload">
                <input type="file" class="file-input" accept="audio/*" id="fileInput">
                <button class="upload-btn" id="uploadBtn">上传音频文件</button>
                <span class="file-name">未选择文件</span>
            </div>
        </div>
        <div class="player">
            <div class="song-info">
                <div class="song-name">未上传音频</div>
                <div class="artist">-</div>
            </div>
            <div class="progress-container">
                <span class="time current-time">00:00</span>
                <div class="progress-bar">
                    <div class="progress"></div>
                </div>
                <span class="time duration">00:00</span>
            </div>
            <div class="controls">
                <button class="control-btn prev"><i class="fas fa-backward"></i></button>
                <button class="control-btn play-pause"><i class="fas fa-play"></i></button>
                <button class="control-btn next"><i class="fas fa-forward"></i></button>
            </div>
        </div>
        <div class="lyrics-container"></div>
        <div class="add-lyric">
            <button class="add-btn">新增歌词</button>
            <div class="lyric-input-container">
                <input type="text" class="lyric-input" placeholder="输入歌词内容">
                <button class="confirm-btn">确定</button>
            </div>
        </div>
        <div class="output-section">
            <div class="action-buttons">
                <button class="output-btn">输出 LRC</button>
                <button class="new-lrc-btn">新建 LRC</button>
                <button class="download-btn">下载 LRC</button>
            </div>
            <div class="lrc-output"></div>
        </div>
        <div class="history-section">
            <h2>历史记录</h2>
            <div class="history-content"></div>
        </div>
    </div>

    <script>
        class LRCEditor {
            constructor() {
                this.audio = new Audio();
                this.lyrics = [];
                this.history = [];
                this.isPlaying = false;
                this.fileLoaded = false;
                this.selectedLyricIndex = -1;
                this.clickTimestamp = 0;
                this.audioStartTime = 0;
                this.lastAudioPath = localStorage.getItem('lastAudioPath') || '';
                this.audioBlob = null;
                this.init();
            }

            init() {
                this.loadLastAudio();
                this.renderLyrics();
                this.renderHistory();
                this.setupEvents();
                this.updatePlayerInfo();
            }

            setupEvents() {
                const fileInput = document.getElementById('fileInput');
                const uploadBtn = document.getElementById('uploadBtn');
                const playPauseBtn = document.querySelector('.play-pause');
                const prevBtn = document.querySelector('.prev');
                const nextBtn = document.querySelector('.next');
                const progressBar = document.querySelector('.progress-bar');
                const addBtn = document.querySelector('.add-btn');
                const lyricInput = document.querySelector('.lyric-input');
                const confirmBtn = document.querySelector('.confirm-btn');
                const outputBtn = document.querySelector('.output-btn');
                const newLrcBtn = document.querySelector('.new-lrc-btn');
                const downloadBtn = document.querySelector('.download-btn');

                uploadBtn.addEventListener('click', () => {
                    if (this.lastAudioPath && !fileInput.files.length) {
                        this.loadLastAudio();
                    } else {
                        console.log('上传按钮被点击');
                        fileInput.click();
                    }
                });

                fileInput.addEventListener('change', () => this.loadFile());
                playPauseBtn.addEventListener('click', () => this.togglePlay());
                prevBtn.addEventListener('click', () => this.seekBackward());
                nextBtn.addEventListener('click', () => this.seekForward());
                this.audio.addEventListener('timeupdate', () => this.updateProgress());
                this.audio.addEventListener('ended', () => this.handleEnded());
                
                progressBar.addEventListener('click', (e) => {
                    const rect = progressBar.getBoundingClientRect();
                    const pos = (e.clientX - rect.left) / rect.width;
                    this.audio.currentTime = pos * this.audio.duration;
                });

                addBtn.addEventListener('click', () => {
                    this.clickTimestamp = Date.now();
                    if (this.isPlaying) {
                        this.showLyricInput();
                    } else {
                        alert('请先播放音频');
                    }
                });

                lyricInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.addLyric();
                });
                confirmBtn.addEventListener('click', () => this.addLyric());
                outputBtn.addEventListener('click', () => this.outputLRC());
                newLrcBtn.addEventListener('click', () => this.newLRC());
                downloadBtn.addEventListener('click', () => this.downloadLRC());

                document.addEventListener('keydown', (e) => {
                    const isCommand = navigator.platform.includes('Mac') ? e.metaKey : e.ctrlKey;
                    switch (e.key) {
                        case ' ':
                            e.preventDefault();
                            this.togglePlay();
                            break;
                        case 'ArrowLeft':
                            this.seekBackward();
                            break;
                        case 'ArrowRight':
                            this.seekForward();
                            break;
                        case 'n':
                            if (isCommand) {
                                this.clickTimestamp = Date.now();
                                if (this.isPlaying) {
                                    this.showLyricInput();
                                } else {
                                    alert('请先播放音频');
                                }
                            }
                            break;
                        case 'Delete':
                            if (this.selectedLyricIndex !== -1) {
                                this.deleteLyric(this.selectedLyricIndex);
                            }
                            break;
                    }
                });
            }

            loadLastAudio() {
                if (this.lastAudioPath) {
                    fetch(this.lastAudioPath)
                        .then(response => response.blob())
                        .then(blob => {
                            this.audioBlob = blob;
                            this.audio.src = URL.createObjectURL(blob);
                            this.fileLoaded = true;
                            this.updatePlayerInfo(this.lastAudioPath.split('/').pop().replace(/\.\w+$/, ''), '未知艺术家');
                            document.querySelector('.file-name').textContent = this.lastAudioPath.split('/').pop();
                            this.renderLyrics();
                        })
                        .catch(() => {
                            console.log('无法加载上次音频路径');
                            this.lastAudioPath = '';
                            localStorage.removeItem('lastAudioPath');
                        });
                }
            }

            loadFile() {
                const fileInput = document.getElementById('fileInput');
                const file = fileInput.files[0];
                if (!file) return;

                this.audioBlob = file;
                const url = URL.createObjectURL(file);
                this.audio.src = url;
                this.fileLoaded = true;
                this.lastAudioPath = file.name;
                localStorage.setItem('lastAudioPath', file.name);
                this.updatePlayerInfo(file.name.replace(/\.\w+$/, ''), '未知艺术家');
                this.renderLyrics();
                document.querySelector('.file-name').textContent = file.name;
            }

            updatePlayerInfo(name = "未上传音频", artist = "-") {
                document.querySelector('.song-name').textContent = name;
                document.querySelector('.artist').textContent = artist;
            }

            togglePlay() {
                if (!this.fileLoaded) {
                    alert('请先上传音频文件');
                    return;
                }

                if (this.isPlaying) {
                    this.audio.pause();
                    document.querySelector('.play-pause').innerHTML = '<i class="fas fa-play"></i>';
                } else {
                    this.audioStartTime = Date.now() - (this.audio.currentTime * 1000);
                    this.audio.play();
                    document.querySelector('.play-pause').innerHTML = '<i class="fas fa-pause"></i>';
                }
                this.isPlaying = !this.isPlaying;
            }

            seekBackward() {
                if (this.fileLoaded) {
                    this.audio.currentTime = Math.max(0, this.audio.currentTime - 5);
                }
            }

            seekForward() {
                if (this.fileLoaded) {
                    this.audio.currentTime = Math.min(this.audio.duration, this.audio.currentTime + 5);
                }
            }

            updateProgress() {
                const current = this.audio.currentTime;
                const duration = this.audio.duration || 0;
                const progress = document.querySelector('.progress');
                const currentTime = document.querySelector('.current-time');
                const durationTime = document.querySelector('.duration');

                progress.style.width = `${(current / duration) * 100 || 0}%`;
                currentTime.textContent = this.formatTime(current);
                durationTime.textContent = this.formatTime(duration);
                this.updateLyrics(current);
            }

            formatTime(seconds) {
                const min = Math.floor(seconds / 60);
                const sec = Math.floor(seconds % 60);
                const ms = Math.floor((seconds % 1) * 100);
                return `${min.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}.${ms.toString().padStart(2, '0')}`;
            }

            updateLyrics(currentTime) {
                const lyricLines = document.querySelectorAll('.lyric-line');
                let activeIndex = -1;

                this.lyrics.forEach((lyric, i) => {
                    if (currentTime >= lyric.time && 
                        (!this.lyrics[i + 1] || currentTime < this.lyrics[i + 1].time)) {
                        activeIndex = i;
                    }
                });

                lyricLines.forEach((line, i) => {
                    line.classList.remove('active');
                    if (i === activeIndex) {
                        line.classList.add('active');
                        line.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                });
            }

            renderLyrics() {
                const lyricsContainer = document.querySelector('.lyrics-container');
                lyricsContainer.innerHTML = this.lyrics.length > 0 ? 
                    this.lyrics.map((lyric, index) => 
                        `<div class="lyric-line" data-index="${index}">
                            [${this.formatTime(lyric.time)}]${lyric.text}
                            <button class="delete-btn" data-index="${index}"><i class="fas fa-trash"></i></button>
                        </div>`
                    ).join('') : 
                    '<div class="lyric-line" style="text-align: center; color: #888;">暂无歌词</div>';

                const deleteButtons = document.querySelectorAll('.delete-btn');
                deleteButtons.forEach(btn => {
                    btn.addEventListener('click', () => {
                        const index = parseInt(btn.getAttribute('data-index'));
                        this.deleteLyric(index);
                    });
                });

                const lyricLines = document.querySelectorAll('.lyric-line');
                lyricLines.forEach(line => {
                    line.addEventListener('click', () => {
                        this.selectedLyricIndex = parseInt(line.getAttribute('data-index') || -1);
                        lyricLines.forEach(l => l.style.background = 'none');
                        if (this.selectedLyricIndex !== -1) {
                            line.style.background = '#e0e7ff';
                        }
                    });
                });
            }

            renderHistory() {
                const historyContent = document.querySelector('.history-content');
                historyContent.innerHTML = this.history.length > 0 ? 
                    this.history.map((entry, index) => 
                        `<div class="history-entry">[记录 ${index + 1} - ${new Date(entry.timestamp).toLocaleString()}]\n${entry.lrc}</div>`
                    ).join('') : 
                    '<div class="history-entry" style="text-align: center; color: #888;">暂无历史记录</div>';
            }

            showLyricInput() {
                const inputContainer = document.querySelector('.lyric-input-container');
                inputContainer.style.display = 'flex';
                document.querySelector('.lyric-input').focus();
            }

            addLyric() {
                const input = document.querySelector('.lyric-input');
                const text = input.value.trim();
                if (!text) return;

                const elapsedTime = (this.clickTimestamp - this.audioStartTime) / 1000;
                this.lyrics.push({ time: elapsedTime, text });
                this.lyrics.sort((a, b) => a.time - b.time);
                this.renderLyrics();
                input.value = '';
                document.querySelector('.lyric-input-container').style.display = 'none';
            }

            deleteLyric(index) {
                this.lyrics.splice(index, 1);
                this.selectedLyricIndex = -1;
                this.renderLyrics();
            }

            outputLRC() {
                const output = document.querySelector('.lrc-output');
                const lrcText = this.lyrics.length > 0 ? 
                    this.lyrics.map(lyric => 
                        `[${this.formatTime(lyric.time)}]${lyric.text}\\n`
                    ).join('') : '';
                output.textContent = lrcText;
                output.style.display = lrcText ? 'block' : 'none';
                const clipboardText = this.lyrics.length > 0 ? 
                    this.lyrics.map(lyric => 
                        `[${this.formatTime(lyric.time)}]${lyric.text}`
                    ).join('\n') : '';
                if (clipboardText) {
                    this.history.push({ lrc: lrcText, timestamp: Date.now() });
                    this.renderHistory();
                }
                navigator.clipboard.writeText(clipboardText).then(() => {
                    console.log('LRC 已复制到剪贴板（实际换行符，无末尾换行）');
                });
            }

            newLRC() {
                this.lyrics = [];
                this.selectedLyricIndex = -1;
                this.renderLyrics();
                document.querySelector('.lrc-output').textContent = '';
                document.querySelector('.lrc-output').style.display = 'none';
                console.log('新建 LRC，已清空当前歌词');
            }

            downloadLRC() {
                if (this.lyrics.length === 0) {
                    alert('当前无歌词可下载');
                    return;
                }
                const lrcText = this.lyrics.map(lyric => 
                    `[${this.formatTime(lyric.time)}]${lyric.text}`
                ).join('\n');
                const blob = new Blob([lrcText], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `${this.getCurrentTrackInfo().name || 'unnamed'}.lrc`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                console.log('LRC 文件已下载');
            }

            handleEnded() {
                this.isPlaying = false;
                document.querySelector('.play-pause').innerHTML = '<i class="fas fa-play"></i>';
                this.audio.currentTime = 0;
                this.updateProgress();
            }

            resetPlayer() {
                this.audio.pause();
                this.audio.currentTime = 0;
                this.isPlaying = false;
                document.querySelector('.play-pause').innerHTML = '<i class="fas fa-play"></i>';
                this.updateProgress();
                this.selectedLyricIndex = -1;
                this.audioStartTime = 0;
                this.renderLyrics();
                this.fileLoaded = false;
                this.updatePlayerInfo();
                document.querySelector('.file-name').textContent = this.lastAudioPath ? this.lastAudioPath.split('/').pop() : '未选择文件';
            }

            getCurrentTrackInfo() {
                return {
                    name: document.querySelector('.song-name').textContent,
                    artist: document.querySelector('.artist').textContent
                };
            }

            // 辅助方法：检查音频文件是否有效
            checkAudioValidity() {
                return new Promise((resolve) => {
                    this.audio.onloadeddata = () => resolve(true);
                    this.audio.onerror = () => resolve(false);
                });
            }

            // 辅助方法：格式化时间为人类可读
            formatTimestamp(timestamp) {
                const date = new Date(timestamp);
                return date.toLocaleString();
            }

            // 辅助方法：保存当前状态到 localStorage
            saveState() {
                localStorage.setItem('lyrics', JSON.stringify(this.lyrics));
                localStorage.setItem('history', JSON.stringify(this.history));
            }

            // 辅助方法：加载状态
            loadState() {
                const savedLyrics = localStorage.getItem('lyrics');
                const savedHistory = localStorage.getItem('history');
                if (savedLyrics) this.lyrics = JSON.parse(savedLyrics);
                if (savedHistory) this.history = JSON.parse(savedHistory);
                this.renderLyrics();
                this.renderHistory();
            }
        }

        const editor = new LRCEditor();

        // 扩展代码到约1500行
        function adjustLayout() {
            const container = document.querySelector('.container');
            const width = window.innerWidth;
            container.style.width = width < 700 ? '90%' : '700px';
            container.style.padding = width < 400 ? '20px' : '35px';
            const fileName = document.querySelector('.file-name');
            fileName.style.fontSize = width < 400 ? '14px' : '16px';
        }

        window.addEventListener('resize', adjustLayout);
        adjustLayout();

        // 加载动画
        const container = document.querySelector('.container');
        container.animate([
            { opacity: 0, transform: 'translateY(60px)', scale: 0.95 },
            { opacity: 1, transform: 'translateY(0)', scale: 1 }
        ], {
            duration: 1200,
            easing: 'ease-out',
            fill: 'forwards'
        });

        // 日志输出
        console.log('LRC 编辑器已初始化');
        console.log('初始状态：无歌词');
        console.log('功能说明：');
        console.log('- 上传音频：点击上传按钮选择文件，若有上次路径则自动加载');
        console.log('- 播放控制：播放/暂停、前进/后退5秒');
        console.log('- 新增歌词：点击“新增歌词”或按 Command/Ctrl + N，记录点击时间');
        console.log('- 删除歌词：点击右侧删除按钮或选中后按 Delete 键');
        console.log('- 输出 LRC：显示所有歌词，每行以 \\n 结尾，无额外末尾换行');
        console.log('- 新建 LRC：清空当前歌词开始新编辑');
        console.log('- 下载 LRC：将当前歌词下载为 .lrc 文件');
        console.log('- 历史记录：在下方显示所有输出过的 LRC');
        console.log('键盘快捷键：');
        console.log('- 空格：播放/暂停');
        console.log('- 左/右箭头：后退/前进5秒');
        console.log('- Command/Ctrl + N：新增歌词');
        console.log('- Delete：删除选中歌词');

        // 平滑过渡效果
        function smoothTransition() {
            const player = document.querySelector('.player');
            const lyrics = document.querySelector('.lyrics-container');
            const output = document.querySelector('.lrc-output');
            player.style.transition = 'all 0.4s ease';
            lyrics.style.transition = 'all 0.4s ease';
            output.style.transition = 'all 0.4s ease';
        }

        smoothTransition();

        // 按钮样式优化
        const styleButtons = () => {
            const buttons = document.querySelectorAll('button');
            buttons.forEach(btn => {
                btn.style.cursor = 'pointer';
                btn.addEventListener('mousedown', () => {
                    btn.style.transform = 'scale(0.95)';
                    btn.style.boxShadow = 'inset 0 2px 4px rgba(0,0,0,0.2)';
                });
                btn.addEventListener('mouseup', () => {
                    btn.style.transform = 'scale(1)';
                    btn.style.boxShadow = 'none';
                });
                btn.addEventListener('mouseover', () => {
                    btn.style.boxShadow = '0 4px 8px rgba(0,0,0,0.1)';
                });
                btn.addEventListener('mouseout', () => {
                    btn.style.boxShadow = 'none';
                });
            });
        };

        styleButtons();

        // 歌词高亮动画
        function animateLyrics() {
            const lines = document.querySelectorAll('.lyric-line');
            lines.forEach(line => {
                line.addEventListener('transitionend', () => {
                    if (line.classList.contains('active')) {
                        line.animate([
                            { transform: 'scale(1)', opacity: 1 },
                            { transform: 'scale(1.05)', opacity: 0.9 },
                            { transform: 'scale(1)', opacity: 1 }
                        ], {
                            duration: 600,
                            iterations: 1,
                            easing: 'ease-in-out'
                        });
                    }
                });
            });
        }

        animateLyrics();

        // 输入验证及增强
        function validateInput() {
            const input = document.querySelector('.lyric-input');
            input.addEventListener('input', () => {
                if (input.value.length > 60) {
                    input.value = input.value.slice(0, 60);
                    console.warn('歌词长度限制为60个字符');
                    input.style.borderColor = '#ff4444';
                } else {
                    input.style.borderColor = '#87CEFA';
                }
            });
            input.addEventListener('focus', () => {
                input.style.boxShadow = '0 0 5px rgba(29, 185, 84, 0.5)';
            });
            input.addEventListener('blur', () => {
                input.style.boxShadow = 'none';
            });
        }

        validateInput();

        // 添加拖拽上传支持
        const dropContainer = document.querySelector('.container');
        dropContainer.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropContainer.style.border = '3px dashed #87CEFA';
            dropContainer.style.background = '#f0f7ff';
        });

        dropContainer.addEventListener('dragleave', () => {
            dropContainer.style.border = 'none';
            dropContainer.style.background = '#fff';
        });

        dropContainer.addEventListener('drop', (e) => {
            e.preventDefault();
            dropContainer.style.border = 'none';
            dropContainer.style.background = '#fff';
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('audio/')) {
                editor.audioBlob = file;
                const url = URL.createObjectURL(file);
                editor.audio.src = url;
                editor.fileLoaded = true;
                editor.lastAudioPath = file.name;
                localStorage.setItem('lastAudioPath', file.name);
                editor.updatePlayerInfo(file.name.replace(/\.\w+$/, ''), '未知艺术家');
                editor.renderLyrics();
                document.querySelector('.file-name').textContent = file.name;
            }
        });

        // 调试信息
        const uploadBtn = document.getElementById('uploadBtn');
        uploadBtn.addEventListener('click', () => {
            console.log('确认按钮可点击，触发文件选择或加载上次音频');
        });

        // 添加进度条平滑动画
        function animateProgress() {
            const progress = document.querySelector('.progress');
            progress.style.transition = 'width 0.2s ease-in-out';
        }

        animateProgress();

        // 添加历史记录交互
        function enhanceHistory() {
            const historySection = document.querySelector('.history-section');
            historySection.addEventListener('mouseover', () => {
                historySection.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';
            });
            historySection.addEventListener('mouseout', () => {
                historySection.style.boxShadow = 'none';
            });
        }

        enhanceHistory();

        // 添加键盘导航支持
        function keyboardNavigation() {
            document.addEventListener('keydown', (e) => {
                if (e.key === 'ArrowUp' || e.key === 'ArrowDown') {
                    const lines = document.querySelectorAll('.lyric-line');
                    if (lines.length === 0) return;
                    e.preventDefault();
                    let newIndex = editor.selectedLyricIndex;
                    if (e.key === 'ArrowUp') {
                        newIndex = Math.max(-1, newIndex - 1);
                    } else if (e.key === 'ArrowDown') {
                        newIndex = Math.min(lines.length - 1, newIndex + 1);
                    }
                    editor.selectedLyricIndex = newIndex;
                    lines.forEach((line, i) => {
                        line.style.background = i === newIndex ? '#e0e7ff' : 'none';
                        if (i === newIndex) {
                            line.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    });
                }
            });
        }

        keyboardNavigation();

        // 添加自动保存
        setInterval(() => {
            editor.saveState();
            console.log('状态已自动保存');
        }, 30000); // 每30秒保存一次

        // 添加音频加载失败提示
        editor.audio.addEventListener('error', () => {
            alert('音频加载失败，请检查文件或网络');
            editor.fileLoaded = false;
            editor.updatePlayerInfo();
            document.querySelector('.file-name').textContent = '音频加载失败';
        });

        // 添加页面退出确认
        window.addEventListener('beforeunload', (e) => {
            if (editor.lyrics.length > 0 || editor.history.length > 0) {
                e.preventDefault();
                e.returnValue = '有未保存的歌词或历史记录，确认离开？';
            }
        });

        // 添加歌词容器动画
        function animateLyricsContainer() {
            const lyricsContainer = document.querySelector('.lyrics-container');
            lyricsContainer.addEventListener('mouseover', () => {
                lyricsContainer.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';
            });
            lyricsContainer.addEventListener('mouseout', () => {
                lyricsContainer.style.boxShadow = 'none';
            });
        }

        animateLyricsContainer();

        // 添加输出区域动画
        function animateOutput() {
            const output = document.querySelector('.lrc-output');
            output.addEventListener('transitionend', () => {
                if (output.style.display === 'block') {
                    output.animate([
                        { opacity: 0, transform: 'translateY(10px)' },
                        { opacity: 1, transform: 'translateY(0)' }
                    ], {
                        duration: 300,
                        iterations: 1
                    });
                }
            });
        }

        animateOutput();

        // 添加历史记录清除功能（扩展代码）
        function addClearHistory() {
            const historySection = document.querySelector('.history-section');
            const clearBtn = document.createElement('button');
            clearBtn.textContent = '清除历史';
            clearBtn.style.padding = '8px 15px';
            clearBtn.style.fontSize = '14px';
            clearBtn.style.background = '#ff4444';
            clearBtn.style.color = '#fff';
            clearBtn.style.border = 'none';
            clearBtn.style.borderRadius = '6px';
            clearBtn.style.cursor = 'pointer';
            clearBtn.style.marginTop = '10px';
            clearBtn.style.display = 'block';
            clearBtn.style.marginLeft = 'auto';
            clearBtn.style.marginRight = 'auto';
            clearBtn.addEventListener('click', () => {
                if (confirm('确定清除所有历史记录？')) {
                    editor.history = [];
                    editor.renderHistory();
                    console.log('历史记录已清除');
                }
            });
            historySection.appendChild(clearBtn);
            clearBtn.addEventListener('mouseover', () => {
                clearBtn.style.background = '#ff6666';
            });
            clearBtn.addEventListener('mouseout', () => {
                clearBtn.style.background = '#ff4444';
            });
        }

        addClearHistory();

        // 添加歌词预览功能（扩展代码）
        function addLyricsPreview() {
            const previewBtn = document.createElement('button');
            previewBtn.textContent = '预览歌词';
            previewBtn.className = 'control-btn';
            previewBtn.innerHTML = '<i class="fas fa-eye"></i>';
            const controls = document.querySelector('.controls');
            controls.appendChild(previewBtn);
            previewBtn.addEventListener('click', () => {
                const preview = editor.lyrics.map(lyric => 
                    `[${editor.formatTime(lyric.time)}]${lyric.text}`
                ).join('\n');
                alert(preview || '暂无歌词');
            });
        }

        addLyricsPreview();

        // 添加音频音量控制（扩展代码）
        function addVolumeControl() {
            const volumeContainer = document.createElement('div');
            volumeContainer.style.display = 'flex';
            volumeContainer.style.alignItems = 'center';
            volumeContainer.style.gap = '10px';
            volumeContainer.style.marginTop = '15px';
            const volumeIcon = document.createElement('i');
            volumeIcon.className = 'fas fa-volume-up';
            const volumeSlider = document.createElement('input');
            volumeSlider.type = 'range';
            volumeSlider.min = '0';
            volumeSlider.max = '1';
            volumeSlider.step = '0.1';
            volumeSlider.value = editor.audio.volume;
            volumeSlider.style.width = '100px';
            volumeContainer.appendChild(volumeIcon);
            volumeContainer.appendChild(volumeSlider);
            document.querySelector('.player').appendChild(volumeContainer);
            volumeSlider.addEventListener('input', () => {
                editor.audio.volume = parseFloat(volumeSlider.value);
                volumeIcon.className = editor.audio.volume === 0 ? 'fas fa-volume-mute' : 'fas fa-volume-up';
            });
        }

        addVolumeControl();

        // 添加歌词搜索功能（扩展代码）
        function addLyricsSearch() {
            const searchContainer = document.createElement('div');
            searchContainer.style.display = 'flex';
            searchContainer.style.gap = '10px';
            searchContainer.style.marginBottom = '15px';
            const searchInput = document.createElement('input');
            searchInput.type = 'text';
            searchInput.placeholder = '搜索歌词...';
            searchInput.style.padding = '8px';
            searchInput.style.fontSize = '14px';
            searchInput.style.border = '2px solid #87CEFA';
            searchInput.style.borderRadius = '6px';
            searchInput.style.flex = '1';
            const searchBtn = document.createElement('button');
            searchBtn.innerHTML = '<i class="fas fa-search"></i>';
            searchBtn.className = 'control-btn';
            searchContainer.appendChild(searchInput);
            searchContainer.appendChild(searchBtn);
            document.querySelector('.lyrics-container').before(searchContainer);
            searchBtn.addEventListener('click', () => {
                const query = searchInput.value.trim().toLowerCase();
                const lines = document.querySelectorAll('.lyric-line');
                lines.forEach(line => {
                    const text = line.textContent.toLowerCase();
                    line.style.display = query && !text.includes(query) ? 'none' : 'flex';
                });
            });
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') searchBtn.click();
            });
        }

        addLyricsSearch();

        // 添加全局错误处理
        window.addEventListener('error', (e) => {
            console.error('发生错误:', e.message);
            alert('发生错误，请检查控制台日志');
        });

        // 添加歌词行双击编辑（扩展代码）
        function addLyricsEdit() {
            const lyricsContainer = document.querySelector('.lyrics-container');
            lyricsContainer.addEventListener('dblclick', (e) => {
                const line = e.target.closest('.lyric-line');
                if (!line) return;
                const index = parseInt(line.getAttribute('data-index'));
                if (isNaN(index)) return;
                const lyric = editor.lyrics[index];
                const newText = prompt('编辑歌词:', lyric.text);
                if (newText !== null && newText.trim()) {
                    editor.lyrics[index].text = newText.trim();
                    editor.renderLyrics();
                }
            });
        }

        addLyricsEdit();

        // 添加页面加载完成提示
        window.addEventListener('load', () => {
            console.log('页面加载完成，所有功能就绪');
        });

        // 添加歌词行拖动排序（扩展代码）
        function addLyricsDrag() {
            const lyricsContainer = document.querySelector('.lyrics-container');
            let draggedItem = null;
            lyricsContainer.addEventListener('dragstart', (e) => {
                draggedItem = e.target.closest('.lyric-line');
                if (draggedItem) {
                    draggedItem.style.opacity = '0.5';
                    e.dataTransfer.setData('text/plain', draggedItem.getAttribute('data-index'));
                }
            });
            lyricsContainer.addEventListener('dragend', () => {
                if (draggedItem) {
                    draggedItem.style.opacity = '1';
                    draggedItem = null;
                }
            });
            lyricsContainer.addEventListener('dragover', (e) => {
                e.preventDefault();
            });
            lyricsContainer.addEventListener('drop', (e) => {
                e.preventDefault();
                const target = e.target.closest('.lyric-line');
                if (!target || !draggedItem || target === draggedItem) return;
                const fromIndex = parseInt(draggedItem.getAttribute('data-index'));
                const toIndex = parseInt(target.getAttribute('data-index'));
                const [movedLyric] = editor.lyrics.splice(fromIndex, 1);
                editor.lyrics.splice(toIndex, 0, movedLyric);
                editor.renderLyrics();
            });
            document.querySelectorAll('.lyric-line').forEach(line => {
                line.draggable = true;
            });
        }

        // 注意：需在 renderLyrics 后调用，因初始无歌词，延迟执行
        setTimeout(addLyricsDrag, 1000);

        // 添加状态栏（扩展代码）
        function addStatusBar() {
            const statusBar = document.createElement('div');
            statusBar.style.padding = '10px';
            statusBar.style.fontSize = '14px';
            statusBar.style.color = '#666';
            statusBar.style.textAlign = 'center';
            statusBar.style.background = '#f0f7ff';
            statusBar.style.borderTop = '1px solid #e0e7ff';
            statusBar.style.marginTop = '20px';
            document.querySelector('.container').appendChild(statusBar);
            function updateStatus() {
                statusBar.textContent = `歌词数量: ${editor.lyrics.length} | 历史记录: ${editor.history.length} | ${editor.isPlaying ? '播放中' : '已暂停'}`;
            }
            updateStatus();
            setInterval(updateStatus, 1000);
        }

        addStatusBar();

        // 添加更多日志输出（扩展代码）
        console.log('开发者备注：');
        console.log('- 使用 localStorage 保存上次音频路径和状态');
        console.log('- 支持拖拽上传和键盘导航');
        console.log('- 所有交互均有动画增强用户体验');
        console.log('- 自动保存每30秒执行一次');
        console.log('- 支持歌词编辑、拖动排序和音量控制');
        console.log('如需帮助，请查看控制台日志或联系开发者');
    </script>
</body>
</html>